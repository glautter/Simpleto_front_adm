<!-- crud-form.component.html-->

<section class="base">
  <!-- Cabeçalho -->
  <header class="base__header">
    <div class="base__title">{{ title || 'Cadastro' }}</div>
    <div class="base__controls">
      <div class="base__actions">
        <button type="button" class="btn icon" (click)="doClose()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
  </header>

  <!-- Formulário -->
  <form [formGroup]="form" (ngSubmit)="submit()" class="crud-form">
    <div class="crud-form__grid">
      @for (f of fields; track $index) {
      <ng-container>
        @if (f.visible !== false) {
        <div class="crud-form__field" [style.gridColumn]="'span ' + getSpan(f)">

          <mat-form-field appearance="outline" floatLabel="auto" class="full-width">
            <mat-label>{{ f.label }}</mat-label>

            <!-- Switch de tipos -->
            <ng-container [ngSwitch]="f.type">
              <!-- Texto -->
              <input *ngSwitchCase="'text'" matInput [formControlName]="f.key"
                [attr.disabled]="f.disabled || readOnly ? true : null" (input)="applyMask($event, f)" />

              <!-- Número -->
              <input *ngSwitchCase="'number'" matInput type="number" [formControlName]="f.key" />

              <!-- Data / DateTime -->
              <ng-container *ngSwitchCase="'date'">
                <input matInput [matDatepicker]="picker" [formControlName]="f.key" />
                <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </ng-container>

              <!-- DateTime (data + hora) -->
              <ng-container *ngSwitchCase="'datetime'">
                <input matInput type="datetime-local" [formControlName]="f.key" [id]="'datetime-' + $index" />
              </ng-container>


              <!-- Imagem -->
              <div *ngSwitchCase="'image'" class="image-upload-container">
                <input type="file" accept="image/*" (change)="onImageSelected($event, f)" />
                <img *ngIf="f.preview" [src]="f.preview" alt="Pré-visualização" class="image-preview" />
              </div>

              <!-- Select -->
              <mat-select *ngSwitchCase="'select'" [formControlName]="f.key">
                <mat-option *ngFor="let o of f.options" [value]="o.value">
                  {{ o.label }}
                </mat-option>
              </mat-select>

              <!-- Textarea -->
              <textarea *ngSwitchCase="'textarea'" matInput [formControlName]="f.key" rows="3"></textarea>

              <!-- Default -->
              <input *ngSwitchDefault matInput [formControlName]="f.key" />
            </ng-container>

            <!-- Mensagem de erro -->
            @if(form.get(f.key)?.invalid && form.get(f.key)?.touched) {
            <mat-error>
              {{ getErrorMessage(f) }}
            </mat-error>
            }
          </mat-form-field>

          <!-- Checkbox (fora do mat-form-field) -->
          @if(f.type === 'checkbox') {
          <mat-checkbox [formControlName]="f.key" class="full-width">
            {{ f.label }}
          </mat-checkbox>
          }
        </div>
        }
      </ng-container>
      }
    </div>

    <!-- Footer com botões -->
    <footer class="base__footer">
      <div class="base__actions">
        <button type="button" mat-button (click)="doCancel()">
          <mat-icon>close</mat-icon>
          Cancelar
        </button>
        <button type="submit" mat-raised-button color="primary" [disabled]="readOnly">
          <mat-icon>save</mat-icon>
          Salvar
        </button>
      </div>
    </footer>
  </form>
</section>